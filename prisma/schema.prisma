// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("POSTGRES_URL_NON_POOLING")
}

enum MembershipRole {
  OWNER
  ADMIN
  EDITOR
  VIEWER
}

model Societe {
  id              String  @id @default(cuid()) // "Euromedmultimedia", "soc_2", etc.
  nom             String
  email           String?
  telephone       String?
  adresse         String?
  codePostal      String?
  ville           String?
  pays            String? @default("France")
  siret           String?
  tvaIntra        String?
  logoUrl         String?
  iban            String?
  bic             String?
  titulaireCompte String?
  mentionsLegales String?
  cgv             String? // Markdown content
  // -- Branding --
  primaryColor    String? @default("#000000")
  secondaryColor  String?

  // -- Settings / Defaults --
  isTemplate        Boolean @default(false)
  defaultTva        Float   @default(20)
  defaultConditions String?
  currency          String  @default("EUR")
  invoicePrefix     String? @default("FACT-")
  quotePrefix       String? @default("DEV-")

  // -- Legal --
  capitalSocial  String?
  formeJuridique String? // SAS, SARL, etc.
  rcs            String?
  siteWeb        String?
  banque         String?


  // -- SMTP / Email --
  emailProvider    String  @default("SMTP") // "SMTP", "GMAIL"
  
  // SMTP Config (Legacy & Current)
  smtpHost   String?
  smtpPort   Int?
  smtpUser   String?
  smtpPass   String?
  smtpSecure Boolean @default(true)
  smtpFrom   String?

  // Gmail / OAuth
  googleRefreshToken String?

  // Templates
  emailSignature String?
  emailTemplates String @default("{}") // JSON: { "invoice": { "subject": "...", "message": "..." }, "quote": ... }

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  clients  Client[]
  produits Produit[]
  factures Facture[]
  devis    Devis[]
  members  User[]         @relation("SocieteMembers")
  memberships Membership[]
  invitations Invitation[]
  history  HistoryEntry[]

  @@index([email])
}

model User {
  id          String  @id @default(cuid())
  email       String  @unique
  password    String // Hashed password
  fullName    String?
  role        String  @default("user") // "admin", "user", "viewer"
  avatarUrl   String?
  avatarBytes Bytes?
  avatarMime  String?
  hasAvatar   Boolean @default(false)
  emailVerified Boolean @default(false)

  // Relations
  societes         Societe[] @relation("SocieteMembers")
  memberships      Membership[]
  invitationsSent  Invitation[] @relation("InvitedBy")
  currentSocieteId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  lastReadHistory DateTime @default(now())

  history HistoryEntry[]
  emailVerificationTokens EmailVerificationToken[]
  passwordResetTokens      PasswordResetToken[]
}

model Client {
  id        String  @id @default(cuid()) // "rec..." or UUID
  societeId String
  societe   Societe @relation(fields: [societeId], references: [id])

  typeClient String  @default("COMPANY") // "INDIVIDUAL" or "COMPANY"
  nom        String
  email      String?
  telephone  String?
  mobile     String?
  adresse    String?
  adresse2   String?
  codePostal String?
  ville      String?
  pays       String? @default("France")
  siret      String?
  tvaIntra   String?
  notes      String?

  // Contact details
  nomContact    String?
  prenomContact String?
  titreContact  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  factures Facture[]
  devis    Devis[]

  @@index([societeId])
  @@index([email])
}

model Produit {
  id        String  @id @default(cuid())
  societeId String
  societe   Societe @relation(fields: [societeId], references: [id])

  nom          String
  description  String?
  prixUnitaire Float   @default(0)
  tva          Float   @default(20)
  unite        String? // "Heure", "Jour", "Forfait"

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([societeId])

  factureItems FactureItem[]
  devisItems   DevisItem[]
}

model Facture {
  id        String  @id @default(cuid())
  societeId String
  societe   Societe @relation(fields: [societeId], references: [id])
  clientId  String
  client    Client  @relation(fields: [clientId], references: [id])

  numero       String // "FAC-2023-001"
  dateEmission DateTime
  dateEcheance DateTime?
  datePaiement DateTime?
  statut       String    @default("Brouillon") // "Brouillon", "Envoyée", "Payée", "Retard", "Annulée"

  totalHT  Float @default(0)
  totalTTC Float @default(0)

  // Storing items as JSON string for now to match Airtable logic exactly
  itemsJSON  String @default("[]")
  emailsJSON String @default("[]")

  conditions String? // Payment terms
  notes      String?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  paiements Paiement[]
  items     FactureItem[]

  isLocked   Boolean   @default(false)
  archivedAt DateTime?
  config     String    @default("{}") // JSON content for UI settings (date col, discounts...)

  @@index([societeId, dateEmission])
  @@index([clientId])
  @@index([statut])
  @@index([deletedAt])
}

model Devis {
  id        String  @id @default(cuid())
  societeId String
  societe   Societe @relation(fields: [societeId], references: [id])
  clientId  String
  client    Client  @relation(fields: [clientId], references: [id])

  numero       String // "DEV-2023-001"
  dateEmission DateTime
  dateValidite DateTime?
  statut       String    @default("Brouillon") // "Brouillon", "Envoyé", "Accepté", "Refusé", "Facturé"

  totalHT  Float @default(0)
  totalTTC Float @default(0)

  itemsJSON  String @default("[]")
  emailsJSON String @default("[]")

  conditions String?
  notes      String?

  isLocked Boolean @default(false)

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?
  config    String    @default("{}")

  items     DevisItem[]

  @@index([societeId, dateEmission])
  @@index([clientId])
  @@index([statut])
}

model Paiement {
  id        String  @id @default(cuid())
  factureId String
  facture   Facture @relation(fields: [factureId], references: [id])

  montant       Float
  datePaiement  DateTime @default(now())
  moyenPaiement String? // "Virement", "CB", "Espèces", "Stripe"
  reference     String? // Transaction ID

  createdAt DateTime @default(now())

  @@index([factureId])
}

model HistoryEntry {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id])

  action      String // "create", "update", "delete", "read", "other"
  entityType  String // "facture", "devis", "client", "produit", "societe", "settings"
  entityId    String?
  description String

  societeId String?
  societe   Societe? @relation(fields: [societeId], references: [id])

  timestamp DateTime @default(now())

  @@index([userId])
  @@index([societeId, timestamp])
  @@index([entityId])
}

model FactureItem {
  id           String  @id @default(cuid())
  factureId    String
  facture      Facture @relation(fields: [factureId], references: [id], onDelete: Cascade)
  produitId    String?
  produit      Produit? @relation(fields: [produitId], references: [id])
  description  String
  quantite     Float
  prixUnitaire Float
  tva          Float
  remise       Float?  @default(0)
  remiseType   String? @default("pourcentage") // "pourcentage" or "montant"
  montantHT    Float

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([factureId])
  @@index([produitId])
}

model DevisItem {
  id           String  @id @default(cuid())
  devisId      String
  devis        Devis   @relation(fields: [devisId], references: [id], onDelete: Cascade)
  produitId    String?
  produit      Produit? @relation(fields: [produitId], references: [id])
  description  String
  quantite     Float
  prixUnitaire Float
  tva          Float
  remise       Float?  @default(0)
  remiseType   String? @default("pourcentage") // "pourcentage" or "montant"
  montantHT    Float

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([devisId])
  @@index([produitId])
}

model Membership {
  id        String         @id @default(cuid())
  userId    String
  user      User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  societeId String
  societe   Societe        @relation(fields: [societeId], references: [id], onDelete: Cascade)
  role      MembershipRole @default(VIEWER)
  status    String         @default("active") // active, invited

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, societeId])
  @@index([userId])
  @@index([societeId])
}

model Invitation {
  id        String         @id @default(cuid())
  email     String
  role      MembershipRole
  societeId String
  societe   Societe        @relation(fields: [societeId], references: [id], onDelete: Cascade)
  invitedBy String
  inviter   User           @relation("InvitedBy", fields: [invitedBy], references: [id])
  token     String         @unique
  status    String         @default("pending") // pending, accepted, expired
  expiresAt DateTime
  createdAt DateTime       @default(now())

  @@unique([email, societeId])
  @@index([token])
  @@index([societeId])
}

model EmailVerificationToken {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  tokenHash String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([tokenHash])
}

model PasswordResetToken {
  id        String    @id @default(cuid())
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  tokenHash String    @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())

  @@index([userId])
  @@index([tokenHash])
}

